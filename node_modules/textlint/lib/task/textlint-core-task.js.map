{"version":3,"sources":["../../src/task/textlint-core-task.js"],"names":[],"mappings":"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","file":"textlint-core-task.js","sourcesContent":["// LICENSE : MIT\n\"use strict\";\nconst EventEmitter = require(\"events\");\nconst TraverseController = require(\"txt-ast-traverse\").Controller;\nconst PromiseEventEmitter = require(\"carrack\");\nconst traverseController = new TraverseController();\nconst debug = require(\"debug\")(\"textlint:core-task\");\nconst assert = require(\"assert\");\nimport RuleError from \"../core/rule-error\";\nimport SourceLocation from \"../core/source-location\";\nimport RuleContext from \"../core/rule-context\";\nimport timing from \"./../util/timing\";\nimport MessageType from \"../shared/type/MessageType\";\nimport {throwWithoutExperimental} from \"../util/throw-log\";\n// Promised EventEmitter\nclass RuleTypeEmitter extends PromiseEventEmitter {\n    constructor() {\n        super();\n        this.setMaxListeners(0);\n    }\n}\nexport default class TextLintCoreTask extends EventEmitter {\n    static get events() {\n        return {\n            // receive start event\n            start: \"start\",\n            // receive message from each rules\n            message: \"message\",\n            // receive complete event\n            complete: \"complete\",\n            // receive error event\n            error: \"error\"\n        };\n    }\n\n    constructor({config, ruleCreatorSet, sourceCode}) {\n        super();\n        this.config = config;\n        this.ruleCreatorSet = ruleCreatorSet;\n        this.sourceCode = sourceCode;\n        this.ruleTypeEmitter = new RuleTypeEmitter();\n        this._setupRuleCreatorListener();\n    }\n\n    /* eslint-disable */\n    /**\n     * return ruleObject\n     * @param {Function} ruleCreator\n     * @param {RuleContext} ruleContext\n     * @param {Object|boolean} ruleConfig\n     * @returns {Object}\n     */\n    getRuleObject(ruleCreator, ruleContext, ruleConfig) {\n        throw new Error(\"Not Implement!!\");\n    }\n\n    /* eslint-enable */\n\n    createIgnoreReporter() {\n        /**\n         * Message of ignoring\n         * @typedef {Object} ReportIgnoreMessage\n         * @property {string} ruleId\n         * @property {number[]} range\n         * @property {string} ignoringRuleId to ignore ruleId\n         * \"*\" is special case, it match all ruleId(work as wildcard).\n         */\n        /**\n         * create ReportIgnoreMessage and emit it.\n         * @param {ReportIgnoreMessage} reportedMessage\n         */\n        const reportFunction = (reportedMessage) => {\n            throwWithoutExperimental(\"shouldIgnore() is experimental feature.\\n\" +\n                \"You can use it with `--experimental` flag. It may will be changed in the future.\");\n            const {ruleId, range, optional} = reportedMessage;\n            assert(typeof range[0] !== \"undefined\" && typeof range[1] !== \"undefined\" && range[0] >= 0 && range[1] >= 0,\n                \"ignoreRange should have actual range: \" + range);\n            const message = {\n                type: MessageType.ignore,\n                ruleId: ruleId,\n                range: range,\n                // ignoring target ruleId - default: filter messages in the rule.\n                ignoringRuleId: optional.ruleId || ruleId\n            };\n            this.emit(TextLintCoreTask.events.message, message);\n        };\n        return reportFunction;\n    }\n\n    createReporter(sourceCode) {\n        const sourceLocation = new SourceLocation(sourceCode);\n\n        /**\n         * @typedef {Object} ReportMessage\n         * @property {string} ruleId\n         * @property {TxtNode} node\n         * @property {number} severity\n         * @property {RuleError} ruleError error is a RuleError instance or any data\n         */\n        /**\n         * push new RuleError to results\n         * @param {ReportMessage} reportedMessage\n         */\n        const reportFunction = (reportedMessage) => {\n            const {ruleId, severity, ruleError} = reportedMessage;\n            debug(\"%s pushReport %s\", ruleId, ruleError);\n            const {line, column, fix} = sourceLocation.adjust(reportedMessage);\n            const index = sourceCode.positionToIndex({line, column});\n            // add TextLintMessage\n            const message = {\n                type: MessageType.lint,\n                ruleId: ruleId,\n                message: ruleError.message,\n                index,\n                // See https://github.com/textlint/textlint/blob/master/typing/textlint.d.ts\n                line: line,        // start with 1(1-based line number)\n                column: column + 1,// start with 1(1-based column number)\n                severity: severity // it's for compatible ESLint formatter\n            };\n            if (fix) {\n                message.fix = fix;\n            }\n            if (!(ruleError instanceof RuleError)) {\n                // `error` is a any data.\n                const data = ruleError;\n                message.data = data;\n            }\n            this.emit(TextLintCoreTask.events.message, message);\n        };\n        return reportFunction;\n    }\n\n    /**\n     * start process and emitting events.\n     * You can listen message by `task.on(\"message\", message => {})`\n     */\n    start() {\n        const promiseQueue = [];\n        const listenerCount = (typeof this.ruleTypeEmitter.listenerCount !== \"undefined\")\n            ? this.ruleTypeEmitter.listenerCount.bind(this.ruleTypeEmitter) // Node 4.x >=\n            : EventEmitter.listenerCount.bind(EventEmitter, this.ruleTypeEmitter);// Node 0.12\n\n        this.emit(TextLintCoreTask.events.start);\n\n        const ruleTypeEmitter = this.ruleTypeEmitter;\n        traverseController.traverse(this.sourceCode.ast, {\n            enter(node, parent) {\n                const type = node.type;\n                Object.defineProperty(node, \"parent\", {value: parent});\n                if (listenerCount(type) > 0) {\n                    const promise = ruleTypeEmitter.emit(type, node);\n                    promiseQueue.push(promise);\n                }\n            },\n            leave(node) {\n                const type = `${node.type}:exit`;\n                if (listenerCount(type) > 0) {\n                    const promise = ruleTypeEmitter.emit(type, node);\n                    promiseQueue.push(promise);\n                }\n            }\n        });\n        Promise.all(promiseQueue).then(() => {\n            this.emit(TextLintCoreTask.events.complete);\n        }).catch(error => {\n            this.emit(TextLintCoreTask.events.error, error);\n        });\n    }\n\n    /**\n     * setup ruleTypeEmitter\n     * @private\n     */\n    _setupRuleCreatorListener() {\n        const rules = this.ruleCreatorSet.rules;\n        const rulesConfig = this.ruleCreatorSet.rulesConfig;\n        const textLintConfig = this.config;\n        const sourceCode = this.sourceCode;\n        const report = this.createReporter(sourceCode);\n        const ignoreReport = this.createIgnoreReporter(sourceCode);\n        Object.keys(rules).forEach(ruleId => {\n            const ruleCreator = rules[ruleId];\n            const ruleConfig = typeof rulesConfig[ruleId] !== \"undefined\" ? rulesConfig[ruleId] : true;\n            const ruleContext = new RuleContext({\n                ruleId,\n                sourceCode,\n                report,\n                ignoreReport,\n                textLintConfig,\n                ruleConfig\n            });\n            const ruleObject = this.getRuleObject(ruleCreator, ruleContext, ruleConfig);\n            this._addListenRule(ruleId, ruleObject);\n        });\n    }\n\n    // add all the node types as listeners\n    _addListenRule(key, rule) {\n        Object.keys(rule).forEach(nodeType => {\n            this.ruleTypeEmitter.on(nodeType, timing.enabled\n                ? timing.time(key, rule[nodeType])\n                : rule[nodeType]);\n        });\n    }\n}\n"]}